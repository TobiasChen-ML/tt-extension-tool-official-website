<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>控制台 - TK 灵犀</title>
  <link rel="stylesheet" href="/static/site.css" />
  <script>
    function toggleSecret(id, btn){
      const input = document.getElementById(id);
      if(!input) return;
      const showing = input.getAttribute('data-showing') === '1';
      input.type = showing ? 'password' : 'text';
      input.setAttribute('data-showing', showing ? '0' : '1');
      if(btn){
        btn.setAttribute('aria-label', showing ? '显示密钥' : '隐藏密钥');
        btn.classList.toggle('on', !showing);
      }
    }
    async function copySecret(id, btn){
      const input = document.getElementById(id);
      if(!input) return;
      try{
        await navigator.clipboard.writeText(input.value);
        btn.textContent = '已复制';
        btn.disabled = true;
        setTimeout(()=>{btn.textContent='复制';btn.disabled=false;}, 1500);
      }catch(e){
        // 兼容方案
        input.select();
        document.execCommand('copy');
        btn.textContent = '已复制';
        btn.disabled = true;
        setTimeout(()=>{btn.textContent='复制';btn.disabled=false;}, 1500);
      }
    }
  </script>
  <style>
    .secret-cell{ display:flex; align-items:center; gap:8px; }
    .secret-input{ width: 420px; }
    .icon-btn{ background:transparent; border:0; cursor:pointer; padding:4px; border-radius:6px; color:#4b5563; }
    .icon-btn:hover{ background: rgba(0,0,0,0.05); }
    .icon-btn.on{ color:#111827; }
    .icon-eye{ width:20px; height:20px; display:block; }
    .copy-btn{ padding:6px 10px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; cursor:pointer; }
    .copy-btn:disabled{ color:#9ca3af; border-color:#e5e7eb; }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container">
      <div class="logo">TK 灵犀</div>
      <nav>
        <a href="/">首页</a>
        <a href="/dashboard/">控制台</a>
      </nav>
      <div class="actions">
        <a class="btn small" href="/logout/">退出登录</a>
      </div>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <div class="dash-header">
        <div>
          <h1 class="dash-title">欢迎，{{ request.user.username }}</h1>
          <p class="dash-sub">在这里管理您的账户、店铺密钥、查看订单与使用情况</p>
        </div>
      </div>

      <div class="metric-row">
        <div class="kpi">
          <div class="num">∞</div>
          <div class="label">剩余积分</div>
        </div>
        <div class="kpi">
          <div class="num">{{ profile.phone|default:'未绑定' }}</div>
          <div class="label">手机绑定</div>
        </div>
        <div class="kpi">
          <div class="num">{{ orders|length }}</div>
          <div class="label">订单数量</div>
        </div>
        <!-- 新增：将账户信息放到第一行最后一列 -->
        <div class="kpi kpi-account">
          <div class="account-title">账户信息</div>
          <div class="profile account-profile">
            <div class="avatar">{{ profile.avatar }}</div>
            <div>
              <div>用户名：{{ request.user.username }}</div>
              <div>手机号：{{ profile.phone|default:'未绑定' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 让店铺密钥占据整行：将 dash-grid 改为单列 -->
      <div class="dash-grid" style="grid-template-columns:1fr">
        <section class="card">
          <header class="card-header">
            <h3>店铺密钥</h3>
          </header>
          <div style="overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:80px">序号</th>
                  <th>店铺代码</th>
                  <th>用户电话</th>
                  <th>密钥</th>
                </tr>
              </thead>
              <tbody>
                {% for sk in store_keys %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ sk.store_code }}</td>
                  <td>{{ sk.user.profile.phone|default:'未绑定' }}</td>
                  <td>
                    <div class="secret-cell">
                      <input id="secret-{{ sk.id }}" class="input secret-input" type="password" value="{{ sk.secret }}" readonly data-showing="0" />
                      <button class="icon-btn" type="button" aria-label="显示密钥" onclick="toggleSecret('secret-{{ sk.id }}', this)">
                        <svg class="icon-eye" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                          <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                      </button>
                      <button class="copy-btn" type="button" onclick="copySecret('secret-{{ sk.id }}', this)">复制</button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4">暂无密钥</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

        <!-- 原“账户信息”卡片已移动到上方第一行，因此这里删除该卡片 -->
      </div>

      <section class="card" style="margin-top:18px">
        <header class="card-header">
          <h3>已购产品 / 订单</h3>
        </header>
        <div style="overflow:auto">
          <table class="table">
            <thead><tr><th>订单号</th><th>金额</th><th>状态</th><th>时间</th><th>用户（手机）</th></tr></thead>
            <tbody>
              {% for o in orders %}
                <tr>
                  <td>{{ o.order_no }}</td>
                  <td>{{ o.amount }}</td>
                  <td>{{ o.get_status_display }}</td>
                  <td>{{ o.created_at }}</td>
                  <td>{{ o.user.profile.phone|default:'未绑定' }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="5">暂无订单</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="card" style="margin-top:18px">
        <header class="card-header">
          <h3>调用日志</h3>
          <div class="card-sub">最近100条</div>
        </header>
        <div style="overflow:auto">
          <table class="table">
            <thead>
              <tr>
                <th style="width:120px">时间</th>
                <th>接口内容</th>
                <th style="width:140px">店铺代码</th>
                <th style="width:120px">消耗积分</th>
                <th style="width:100px">状态</th>
                <th style="width:140px">用户（手机）</th>
              </tr>
            </thead>
            <tbody>
              {% for log in usage_logs %}
              <tr>
                <td>{{ log.created_at|date:'Y-m-d H:i:s' }}</td>
                <td>{{ log.content }}</td>
                <td>{{ log.store_code }}</td>
                <td>{{ log.points_consumed }}</td>
                <td>{{ log.status }}</td>
                <td>{{ log.user.profile.phone|default:'未绑定' }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6">暂无调用日志</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <div class="footer-actions">
        <a href="/logout/">退出登录</a>
      </div>
    </div>
  </main>
</body>
</html>